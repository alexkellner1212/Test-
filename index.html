<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LKW Logistik Dashboard V4.1 (Schmaler Graph)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text: #1f2937;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --future: #6366f1;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1, h2, h3 { color: #111827; }
        h2 { border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; margin-top: 0; font-size: 1.25rem; }

        /* Grid Layout */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 40px; }
        .full-width { grid-column: 1 / -1; }
        
        /* Cards */
        .card { background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }

        /* Formular */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; }
        input, select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 4px; box-sizing: border-box; }
        
        /* Buttons */
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; color: white; transition: 0.2s; }
        .btn-primary { background-color: var(--primary); width: 100%; font-size: 16px; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-success { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); }
        .btn-mail { background-color: var(--warning); color: black; }
        .btn-small { padding: 5px 10px; font-size: 12px; }

        /* Tabellen */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
        th { background-color: #f9fafb; font-weight: 600; }
        
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.85em; font-weight: bold; }
        .in { background-color: #d1fae5; color: #065f46; }
        .out { background-color: #fef3c7; color: #92400e; }
        
        /* Status Zeilen */
        .row-overdue { background-color: #fee2e2; border-left: 5px solid var(--danger); }
        .row-planned { border-left: 5px solid var(--primary); }
        .row-future { border-left: 5px solid var(--future); color: #555; }

        /* Statistik Boxen */
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-box { background: var(--card-bg); padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.1); border-left: 5px solid var(--primary); }
        .stat-number { font-size: 24px; font-weight: bold; display: block; margin-top: 5px;}

        /* Bereiche trennen */
        .section-title { margin-top: 40px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .section-icon { font-size: 1.5em; }

        /* Chart Container - HIER GE√ÑNDERT: H√∂he reduziert */
        .chart-container { position: relative; height: 180px; width: 100%; }

        @media (max-width: 900px) { .dashboard-grid, .stats-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1>üöõ Logistik Leitstand</h1>
        <button onclick="clearAllData()" class="btn btn-danger btn-small">Alle Daten l√∂schen</button>
    </div>

    <div class="stats-row">
        <div class="stat-box" style="border-left-color: #2563eb;">
            <span class="stat-label">Fr√ºhschicht (Heute)</span>
            <span class="stat-number" id="stat-early">0</span>
        </div>
        <div class="stat-box" style="border-left-color: #7c3aed;">
            <span class="stat-label">Sp√§tschicht (Heute)</span>
            <span class="stat-number" id="stat-late">0</span>
        </div>
        <div class="stat-box" style="border-left-color: #db2777;">
            <span class="stat-label">Sto√üzeit</span>
            <span class="stat-number" id="stat-peak">-</span>
        </div>
    </div>

    <div class="card full-width">
        <h2>üìà Auslastung & Frequenz (Heute)</h2>
        <div class="chart-container">
            <canvas id="frequencyChart"></canvas>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="card">
            <h2>‚ö° Sofort-Erfassung (Heute)</h2>
            <form id="logForm">
                <div class="form-group">
                    <label>Uhrzeit (Ankunft)</label>
                    <input type="time" id="logTime" required>
                </div>
                <div class="form-group">
                    <label>Spedition</label>
                    <input type="text" id="logSpedition" placeholder="z.B. DHL" required>
                </div>
                <div class="form-group">
                    <label>Kennzeichen</label>
                    <input type="text" id="logPlate" placeholder="K-AB 123">
                </div>
                <div class="form-group">
                    <label>Ware</label>
                    <input type="text" id="logWare" placeholder="Stahl, Paletten..." required>
                </div>
                <div class="form-group">
                    <label>Vorgang</label>
                    <select id="logType">
                        <option value="Anlieferung">Anlieferung</option>
                        <option value="Abholung">Abholung</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">LKW ist da (Erfassen)</button>
            </form>
        </div>

        <div class="card">
            <h2>‚úÖ Abgefertigte / Anwesende LKW (Heute)</h2>
            <div style="overflow-x:auto;">
                <table id="logTable">
                    <thead>
                        <tr>
                            <th>Zeit</th>
                            <th>Typ</th>
                            <th>Spedition</th>
                            <th>Kennz.</th>
                            <th>Ware</th>
                            <th>L√∂schen</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <hr style="border:0; border-top: 2px dashed #ccc; margin: 40px 0;">

    <div class="section-title">
        <span class="section-icon">üìÖ</span>
        <h2>Planung & Vorschau</h2>
    </div>

    <div class="dashboard-grid">
        <div class="card">
            <h2>Neuen LKW vorplanen</h2>
            <form id="planForm">
                <div class="form-group">
                    <label>Geplantes Datum</label>
                    <input type="date" id="planDate" required>
                </div>
                <div class="form-group">
                    <label>Geplante Uhrzeit</label>
                    <input type="time" id="planTime" required>
                </div>
                <div class="form-group">
                    <label>Spedition</label>
                    <input type="text" id="planSpedition" required>
                </div>
                <div class="form-group">
                    <label>Kennzeichen (Optional)</label>
                    <input type="text" id="planPlate">
                </div>
                <div class="form-group">
                    <label>Ware</label>
                    <input type="text" id="planWare" required>
                </div>
                <div class="form-group">
                    <label>Vorgang</label>
                    <select id="planType">
                        <option value="Anlieferung">Anlieferung</option>
                        <option value="Abholung">Abholung</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success" style="width:100%">Zur Planung hinzuf√ºgen</button>
            </form>
        </div>

        <div style="display: flex; flex-direction: column; gap: 20px;">
            
            <div class="card">
                <h2 style="color: #2563eb;">üî• Vorschau Heute (<span id="dateDisplayToday"></span>)</h2>
                <div style="overflow-x:auto;">
                    <table id="planTableToday">
                        <thead>
                            <tr>
                                <th>Plan-Zeit</th>
                                <th>Status</th>
                                <th>Spedition</th>
                                <th>Kennz.</th>
                                <th>Ware</th>
                                <th>Aktion</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <p id="noTodayMsg" style="text-align:center; color:#999; display:none;">Keine weiteren LKW f√ºr heute geplant.</p>
            </div>

            <div class="card" style="background-color: #f8fafc; border: 1px solid #e2e8f0;">
                <h2 style="color: #6366f1;">üîú Zuk√ºnftige Anlieferungen</h2>
                <div style="overflow-x:auto;">
                    <table id="planTableFuture">
                        <thead>
                            <tr>
                                <th>Datum</th>
                                <th>Zeit</th>
                                <th>Spedition</th>
                                <th>Ware</th>
                                <th>Aktion</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                 <p id="noFutureMsg" style="text-align:center; color:#999; display:none;">Keine zuk√ºnftigen Planungen.</p>
            </div>

        </div>
    </div>
</div>

<script>
    // --- STATE MANAGEMENT ---
    let lkwLog = JSON.parse(localStorage.getItem('lkwLog')) || [];
    let lkwPlan = JSON.parse(localStorage.getItem('lkwPlan')) || [];
    let myChart = null;

    const EMAIL_RECIPIENT = "alexander.kellner@haertecenter.de";

    // --- INITIALISIERUNG ---
    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('planDate').value = today;
        document.getElementById('dateDisplayToday').textContent = new Date().toLocaleDateString('de-DE');

        setNow('logTime');
        
        initChart();

        lkwPlan = lkwPlan.map(entry => {
            if(!entry.date) entry.date = today; 
            return entry;
        });

        renderAll();
        setInterval(renderAll, 60000); 
    });

    // --- CHART LOGIK ---
    function initChart() {
        const ctx = document.getElementById('frequencyChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Anzahl LKW',
                    data: [],
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#2563eb'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    },
                    x: {
                        grid: { display: false }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    function updateChart() {
        if(!myChart) return;

        const hours = [];
        const data = [];
        const todayStr = new Date().toISOString().split('T')[0];
        
        // Zeige nur Stunden von 06 bis 22 Uhr f√ºr bessere √úbersicht
        for(let i=6; i<=22; i++) {
            hours.push(i.toString().padStart(2, '0') + ' Uhr');
        }

        const counts = {};
        lkwLog.forEach(entry => {
            if(entry.date === todayStr) {
                const h = parseInt(entry.time.split(':')[0]);
                counts[h] = (counts[h] || 0) + 1;
            }
        });

        for(let i=6; i<=22; i++) {
            data.push(counts[i] || 0);
        }

        myChart.data.labels = hours;
        myChart.data.datasets[0].data = data;
        myChart.update();
    }

    // --- FORMULARE & LOGIK ---

    document.getElementById('logForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const entry = getFormData('log');
        entry.date = new Date().toISOString().split('T')[0];
        entry.shift = calculateShift(entry.time);
        lkwLog.push(entry);
        saveAndRender();
        this.reset();
        setNow('logTime');
    });

    document.getElementById('planForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const dateVal = document.getElementById('planDate').value;
        const timeVal = document.getElementById('planTime').value;
        const speditionVal = document.getElementById('planSpedition').value;
        const plateVal = document.getElementById('planPlate').value || '-';
        const wareVal = document.getElementById('planWare').value;
        const typeVal = document.getElementById('planType').value;

        lkwPlan.push({
            id: Date.now(),
            date: dateVal, time: timeVal, spedition: speditionVal, 
            plate: plateVal, ware: wareVal, type: typeVal, notified: false
        });
        saveAndRender();
        this.reset();
        document.getElementById('planDate').value = new Date().toISOString().split('T')[0];
    });

    function getFormData(prefix) {
        return {
            id: Date.now(),
            time: document.getElementById(prefix + 'Time').value,
            spedition: document.getElementById(prefix + 'Spedition').value,
            plate: document.getElementById(prefix + 'Plate').value || '-',
            ware: document.getElementById(prefix + 'Ware').value,
            type: document.getElementById(prefix + 'Type').value
        };
    }

    function calculateShift(timeStr) {
        const hour = parseInt(timeStr.split(':')[0]);
        if (hour >= 6 && hour < 14) return "Fr√ºh";
        if (hour >= 14 && hour < 22) return "Sp√§t";
        return "Nacht";
    }

    function checkIn(id) {
        const index = lkwPlan.findIndex(x => x.id === id);
        if (index > -1) {
            const item = lkwPlan[index];
            const now = new Date();
            const timeStr = now.toTimeString().substring(0,5);
            const dateStr = now.toISOString().split('T')[0];
            
            const logEntry = {
                ...item, id: Date.now(), date: dateStr, time: timeStr, shift: calculateShift(timeStr)
            };
            lkwLog.push(logEntry);
            lkwPlan.splice(index, 1);
            saveAndRender();
        }
    }

    function deleteLog(id) {
        if(confirm("Eintrag wirklich l√∂schen?")) {
            lkwLog = lkwLog.filter(x => x.id !== id);
            saveAndRender();
        }
    }
    
    function deletePlan(id) {
        if(confirm("Planung l√∂schen?")) {
            lkwPlan = lkwPlan.filter(x => x.id !== id);
            saveAndRender();
        }
    }

    function sendLateMail(id) {
        const item = lkwPlan.find(x => x.id === id);
        if(!item) return;
        const subject = `VERZUG: LKW ${item.spedition} √ºberf√§llig`;
        const body = `Hallo Alexander,\n\nder geplante LKW ist √ºberf√§llig.\n\nPlan-Datum: ${item.date}\nPlan-Zeit: ${item.time}\nSpedition: ${item.spedition}\nWare: ${item.ware}\nKennzeichen: ${item.plate}\n\nBitte pr√ºfen.`;
        window.location.href = `mailto:${EMAIL_RECIPIENT}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    }

    function saveAndRender() {
        localStorage.setItem('lkwLog', JSON.stringify(lkwLog));
        localStorage.setItem('lkwPlan', JSON.stringify(lkwPlan));
        renderAll();
    }

    function renderAll() {
        renderLogTable();
        renderPlanTables();
        calculateStats();
        updateChart();
    }

    function renderLogTable() {
        const tbody = document.querySelector('#logTable tbody');
        tbody.innerHTML = '';
        const todayStr = new Date().toISOString().split('T')[0];

        const sorted = [...lkwLog].sort((a,b) => {
            if(b.date !== a.date) return b.date.localeCompare(a.date);
            return b.time.localeCompare(a.time);
        });

        sorted.forEach(entry => {
            if(entry.date !== todayStr) return; 

            const badgeClass = entry.type === 'Anlieferung' ? 'in' : 'out';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><strong>${entry.time}</strong></td>
                <td><span class="badge ${badgeClass}">${entry.type}</span></td>
                <td>${entry.spedition}</td>
                <td>${entry.plate}</td>
                <td>${entry.ware}</td>
                <td><button onclick="deleteLog(${entry.id})" class="btn btn-danger btn-small">X</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderPlanTables() {
        const tbodyToday = document.querySelector('#planTableToday tbody');
        const tbodyFuture = document.querySelector('#planTableFuture tbody');
        tbodyToday.innerHTML = '';
        tbodyFuture.innerHTML = '';

        const todayStr = new Date().toISOString().split('T')[0];
        const now = new Date();
        const currentMinutes = now.getHours() * 60 + now.getMinutes();

        const sorted = [...lkwPlan].sort((a,b) => {
            if(a.date !== b.date) return a.date.localeCompare(b.date);
            return a.time.localeCompare(b.time);
        });

        let countToday = 0;
        let countFuture = 0;

        sorted.forEach(entry => {
            if (entry.date === todayStr) {
                countToday++;
                const [h, m] = entry.time.split(':').map(Number);
                const planMinutes = h * 60 + m;
                const isLate = currentMinutes > planMinutes;
                
                const tr = document.createElement('tr');
                tr.className = isLate ? 'row-overdue' : 'row-planned';

                let statusHtml = isLate ? '<span style="color:#ef4444; font-weight:bold;">‚ö†Ô∏è √úberf√§llig</span>' : '<span style="color:#6b7280;">Geplant</span>';
                let actionHtml = isLate
                    ? `<button onclick="checkIn(${entry.id})" class="btn btn-success btn-small">Ist jetzt da</button> <button onclick="sendLateMail(${entry.id})" class="btn btn-mail btn-small" style="margin-top:5px;">üìß Mail</button>`
                    : `<button onclick="checkIn(${entry.id})" class="btn btn-success btn-small">‚úÖ Ist da</button> <button onclick="deletePlan(${entry.id})" class="btn btn-danger btn-small" style="margin-left:5px;">L√∂schen</button>`;

                tr.innerHTML = `<td><strong>${entry.time}</strong></td><td>${statusHtml}</td><td>${entry.spedition}</td><td>${entry.plate}</td><td>${entry.ware}</td><td>${actionHtml}</td>`;
                tbodyToday.appendChild(tr);

            } else if (entry.date > todayStr) {
                countFuture++;
                const tr = document.createElement('tr');
                tr.className = 'row-future';
                const d = new Date(entry.date);
                tr.innerHTML = `<td><strong>${d.toLocaleDateString('de-DE')}</strong></td><td>${entry.time}</td><td>${entry.spedition}</td><td>${entry.ware}</td><td><button onclick="deletePlan(${entry.id})" class="btn btn-danger btn-small">L√∂schen</button></td>`;
                tbodyFuture.appendChild(tr);
            }
        });

        document.getElementById('noTodayMsg').style.display = countToday === 0 ? 'block' : 'none';
        document.getElementById('noFutureMsg').style.display = countFuture === 0 ? 'block' : 'none';
    }

    function calculateStats() {
        let early = 0, late = 0;
        let hours = {};
        const todayStr = new Date().toISOString().split('T')[0];

        lkwLog.forEach(e => {
            if(e.date === todayStr) {
                if(e.shift === 'Fr√ºh') early++;
                if(e.shift === 'Sp√§t') late++;
                const h = parseInt(e.time.split(':')[0]);
                hours[h] = (hours[h] || 0) + 1;
            }
        });

        let max = 0, peak = '-';
        for(let [h, c] of Object.entries(hours)) {
            if(c > max) { max = c; peak = `${h}-${parseInt(h)+1} Uhr`; }
        }

        document.getElementById('stat-early').textContent = early;
        document.getElementById('stat-late').textContent = late;
        document.getElementById('stat-peak').textContent = peak;
    }

    function setNow(id) {
        const now = new Date();
        const el = document.getElementById(id);
        if(el) el.value = now.toTimeString().substring(0,5);
    }

    function clearAllData() {
        if(confirm("ACHTUNG: Alle Daten werden gel√∂scht!")) {
            lkwLog = []; lkwPlan = []; saveAndRender();
        }
    }
</script>

</body>
</html>
